"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[5086],{8570:(e,t,r)=>{r.d(t,{Zo:()=>u,kt:()=>y});var n=r(79);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var l=n.createContext({}),c=function(e){var t=n.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):o(o({},t),e)),r},u=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=c(r),y=a,h=d["".concat(l,".").concat(y)]||d[y]||p[y]||i;return r?n.createElement(h,o(o({ref:t},u),{},{components:r})):n.createElement(h,o({ref:t},u))}));function y(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=r.length,o=new Array(i);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,o[1]=s;for(var c=2;c<i;c++)o[c]=r[c];return n.createElement.apply(null,o)}return n.createElement.apply(null,r)}d.displayName="MDXCreateElement"},2578:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var n=r(7626),a=(r(79),r(8570));const i={sidebar_position:1},o="Sync Server",s={unversionedId:"sync/server",id:"sync/server",title:"Sync Server",description:"Verdant doesn't sync by default. It's offline-first, sync-optional. I built it that way because my goal is to support nice local-only anonymous experiences, and add sync & realtime on as an incentive to sign up (and potentially subscribe) to your app.",source:"@site/docs/sync/server.md",sourceDirName:"sync",slug:"/sync/server",permalink:"/docs/sync/server",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Sync",permalink:"/docs/category/sync"},next:{title:"Authenticating Sync",permalink:"/docs/sync/authentication"}},l={},c=[{value:"Profiles",id:"profiles",level:2},{value:"Evicting libraries from server storage",id:"evicting-libraries-from-server-storage",level:2},{value:"Using eviction for contingency scenarios",id:"using-eviction-for-contingency-scenarios",level:3}],u={toc:c};function p(e){let{components:t,...r}=e;return(0,a.kt)("wrapper",(0,n.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"sync-server"},"Sync Server"),(0,a.kt)("p",null,"Verdant doesn't sync by default. It's offline-first, sync-optional. I built it that way because my goal is to support nice local-only anonymous experiences, and add sync & realtime on as an incentive to sign up (and potentially subscribe) to your app."),(0,a.kt)("p",null,"To start syncing, you must first host a server - just a few lines of code."),(0,a.kt)("p",null,"The server can be run standalone, or plugged into an existing HTTP server. It requires a few things to be constructed:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"A path to a SQLite database to store data"),(0,a.kt)("li",{parentName:"ul"},"An authorization function which it uses to determine connected client identity and library access"),(0,a.kt)("li",{parentName:"ul"},"Optional: an interface implementation to provide more detailed user profile information for presence features")),(0,a.kt)("p",null,"Create a server like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"import { Server } from '@verdant-web/server';\n\nconst server = new Server({\n    databaseFile: 'path/to/db.sqlite',\n    tokenSecret: process.env.LOFI_SECRET,\n    // below fields are optional\n    profiles: {\n        get: async (userId: string) => {\n            // you could fetch a profile record from a database here to augment\n            // this profile with name, image, etc.\n            // values will be cached, so don't worry too much about timing.\n            return { id: userId };\n        },\n    },\n    // supposing you're using Express or another server already,\n    // you can attach Verdant to it instead of running it separately.\n    httpServer: myExistingServer,\n});\n\n// if you did not provide your own http server, call listen to begin\n// serving requests\nserver.listen(8080, () => {\n    console.log('Ready!');\n});\n")),(0,a.kt)("p",null,"If you want to attach to an existing HTTP server, you will also need to set up an HTTP endpoint to handle HTTP requests on the ",(0,a.kt)("inlineCode",{parentName:"p"},"/sync")," subpath. For example, using Express:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"app.use('/sync', server.handleRequest);\n")),(0,a.kt)("p",null,"Custom HTTP server support is a little limited right now. It should support Connect/Express-like middleware."),(0,a.kt)("h2",{id:"profiles"},"Profiles"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"profiles")," configuration option accepts anything that implements the profiles interface - which is just a ",(0,a.kt)("inlineCode",{parentName:"p"},"get(userId)")," function. It can return any data your app permanently associates with a particular user. This data is utilized in the ",(0,a.kt)("a",{parentName:"p",href:"./presence"},"presence")," system to give clients access to read-only, trusted information about particular users. A default name is recommended if you have one for your user. A profile image is also a good idea!"),(0,a.kt)("h2",{id:"evicting-libraries-from-server-storage"},"Evicting libraries from server storage"),(0,a.kt)("p",null,"In keeping with the Verdant principle of ",(0,a.kt)("a",{parentName:"p",href:"../manifesto"},"matching infrastructure cost with user revenue"),', the server lets you selectively "evict" libraries from storage.'),(0,a.kt)("p",null,"You can evict libraries when a user ends their subscription. This will free up space in your database without disrupting the user's local copy of their data."),(0,a.kt)("p",null,"If the user decides to subscribe again, you don't need to do anything - whenever they sync again, the server will be sure to restore the library from their replica."),(0,a.kt)("p",null,"To evict a library, just call ",(0,a.kt)("inlineCode",{parentName:"p"},"server.evictLibrary('library-id')"),"."),(0,a.kt)("h3",{id:"using-eviction-for-contingency-scenarios"},"Using eviction for contingency scenarios"),(0,a.kt)("p",null,"Although I've done a lot of testing to try to make Verdant as consistent and reliable as possible under a variety of circumstances, I can never guarantee it's bug-free."),(0,a.kt)("p",null,"You may reach a situation where a user reaches out about problems with sync. Maybe devices are not consistent, or changes are being reverted."),(0,a.kt)("p",null,"The first thing to check would be that the user has the latest version of your client code. But after that, you could expose an admin-only endpoint on your server which calls ",(0,a.kt)("inlineCode",{parentName:"p"},"server.evictLibrary"),". This may seem dangerous, but it's pretty safe! The user will need to reconnect with a device which has a good copy of their data to restore their library to the server. If they're already connected to sync when you do this, their device will reconnect and reupload automatically."),(0,a.kt)("p",null,"Other replicas which may have interacted with the library will be forced to reset back to this known state, so they'll lose any offline or out-of-sync changes -- but that's kind of the point; starting back at a clean slate."),(0,a.kt)("p",null,"If this ever does happen to you, reach out with any details you can give me about what happened. Although I do feel better having these failsafes, I'd rather have Verdant be 100% reliable and bug-free."))}p.isMDXComponent=!0}}]);